#include <stdio.h>
#include <stdlib.h>
#include <string.h>

struct books{
    char* num;
    char* author;
    char* title;
    char* qf;
    char* qt;
};
int quantity(FILE*);

char* scan(int*, FILE*);

struct books* input(struct books*, FILE*);

void show(struct books*, int);

char* scan_console();

void input_file(int, FILE*, struct books*);

void delete(FILE*, struct books*, int);

void refresh(FILE*, struct books*, int);

int main()
{
    int v;
    FILE* file = fopen("books.csv", "a+");
    printf("Choose an option :\n");
    printf("1. Show all books\n");
    printf("2. Add a book\n");
    printf("3. Delete book\n");
    scanf("%d", &v);
    int digit;
    struct books *book = malloc(1 * sizeof(struct books));
    digit = quantity(file);
    book = input(book, file);
    if (v == 1) {
        show(book, digit);
        fclose(file);
    }
    if (v == 2){
        getchar();
        input_file(digit + 1, file, book);
        fclose(file);
    }
    if (v == 3){
        getchar();
        delete(file, book, digit);
        fclose(file);
        FILE* f = fopen("books.csv", "w");
        refresh(f, book, digit - 1);
    }
    return 0;
}

int quantity(FILE* fp){
    int n = 1;
    char c = fgetc(fp);
    while (c != EOF){
        if (c == '\n') n++;
        c = fgetc(fp);
    }
    rewind(fp);
    return(n);
}

struct books* input(struct books* book, FILE* fp)
{
    int n = 0;
    int checker = 0;
    while (checker != 1)
    {
        book[n].num = scan(&checker, fp);
        book[n].author = scan(&checker, fp);
        book[n].title = scan(&checker, fp);
        book[n].qf = scan(&checker, fp);
        book[n].qt = scan(&checker, fp);
        n++;
        book = realloc(book, (n + 1) * sizeof(struct books));
    }
    return book;
}

char* scan(int* checker, FILE* fp)
{
    int n = 1;
    int i = 0;
    char c;
    char* str = malloc(1 * sizeof(char));
    while ((c = getc(fp)) != ';' && c != '\n' && c != EOF)
    {
        *(str + i) = c;
        i += 1;
        str = realloc(str, (i + 1) * sizeof(char));
    }
    *(str + i) = '\0';
    if (c == EOF)
        *checker = 1;
    return str;
}

void show(struct books* book, int n)
{
    for (int i = 0; i < n; ++i)
    {
        printf("%s %s %s %s %s\n", book[i].num, book[i].author, book[i].title, book[i].qf, book[i].qt);
    }
}

char* scan_console()
{
    int i = 0;
    char c;
    char* str = malloc(1 * sizeof(char));
    while ((c = getchar()) != ';' && c != '\n' && c != EOF)
    {
        *(str + i) = c;
        i++;
        str = realloc(str, (i + 1) * sizeof(char));
    }
    *(str + i) = '\0';
    return (str);
}

void input_file(int digit, FILE* fp, struct books* book){
    printf("Input book info:\n");
    book = realloc(book, (digit + 1) * sizeof(struct books));
    book[digit].num = scan_console();
    book[digit].author = scan_console();
    book[digit].title = scan_console();
    book[digit].qf = scan_console();
    book[digit].qt = scan_console();
    fprintf(fp, "\n%s;%s;%s;%s;%s", book[digit].num, book[digit].author, book[digit].title, book[digit].qf, book[digit].qt);
}

void delete(FILE* fp, struct books* book, int n){
    printf("\nEnter an ISBN code of a book you want to delete:\n");
    int i = 0;
    int index = 0;
    char c;
    char* str = malloc(1 * sizeof(char));
    while ((c = getchar()) != '\n')
    {
        *(str + i) = c;
        i++;
        str = realloc(str, (i + 1) * sizeof(char));
    }
    *(str + i) = '\0';
    for (i = 0; i < n; i++) {
        if (strcmp (book[i].num, str) == 0) index = i;
    }
    for (i = index; i < n - 1; ++i) {
        book[i].num = book[i + 1].num;
        book[i].author = book[i + 1].author;
        book[i].title = book[i + 1].title;
        book[i].qf = book[i + 1].qf;
        book[i].qt = book[i + 1].qt;
    }
    book[n].num = NULL;
    book[n].author = NULL;
    book[n].title = NULL;
    book[n].qf = NULL;
    book[n].qt = NULL;
}

void refresh(FILE* fp, struct books* book, int n){
    book = realloc(book, (n) * sizeof(struct books));
    for (int i = 0; i < n - 1; ++i) {
        fprintf(fp, "%s;%s;%s;%s;%s\n", book[i].num, book[i].author, book[i].title, book[i].qf, book[i].qt);
    }
    fprintf(fp, "%s;%s;%s;%s;%s", book[n - 1].num, book[n - 1].author, book[n - 1].title, book[n - 1].qf, book[n - 1].qt);
}
